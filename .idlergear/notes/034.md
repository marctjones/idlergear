---
id: 34
created: '2026-01-11T04:39:00.518595Z'
tags:
- explore
- design
---
# Design Analysis: `ig run` for External Terminal Tracking

## The Problem Being Solved

When working with AI assistants, a common pattern is:
1. AI assistant is running in Terminal A
2. User runs a script/command in Terminal B (separate terminal)
3. User copy-pastes output from Terminal B into Terminal A
4. AI assistant has no context about:
   - WHEN the command was run
   - WHICH VERSION of a script was run
   - Whether the output is complete or truncated
   - Access to the full logs

This creates ambiguity: "Is this the output from the latest version of the script or an older one?"

## Alignment with IdlerGear Vision

Looking at the vision, IdlerGear already has "Runs" as one of the 6 knowledge types:
> **Runs** - Results from executed processes. Logs, test results, script output. Queryable history of what happened.

The existing `idlergear run start` command already:
- Tracks PIDs
- Captures stdout/stderr to log files
- Registers with daemon
- Can stream logs to daemon

**What's missing:** A way for the USER to invoke a command from their own terminal that:
1. Registers with IdlerGear before running
2. Outputs a unique identifier the AI can recognize
3. Makes logs accessible to the AI assistant

## Design Options

### Option A: Wrapper Script (`ig run`)
```bash
ig run ./my-script.sh
```
- Wraps the command execution
- Prints hash/version before running
- Captures logs
- Streams to OTEL collector

**Pros:** Simple UX, complete control
**Cons:** Might interfere with interactive commands, tty handling

### Option B: Registration + Manual Execution
```bash
ig run register ./my-script.sh  # Returns run ID and script hash
./my-script.sh 2>&1 | ig run stream <id>  # Streams output
ig run complete <id>  # Marks complete
```

**Pros:** More flexible, works with any command style
**Cons:** More steps, user might forget to complete

### Option C: Hybrid with Header/Footer
```bash
ig run ./my-script.sh
```
Outputs:
```
═══ IDLERGEAR RUN ═══════════════════════════════════════════
Run ID: abc123
Script: ./my-script.sh
Hash:   sha256:a1b2c3d4...
Time:   2026-01-11T04:30:00Z
══════════════════════════════════════════════════════════════
[actual script output here]
═══ IDLERGEAR RUN COMPLETE ══════════════════════════════════
Exit Code: 0
Duration:  12.3s
══════════════════════════════════════════════════════════════
```

**Pros:** When user pastes output, AI sees context
**Cons:** Adds noise to output

## Recommended Design: Option A with OTEL Integration

### CLI: `ig run`

This is a NEW binary/alias that's designed to be run from user's terminal (not the AI's terminal).

```bash
# Simple usage - wrap any command
ig run ./train.sh

# Named run
ig run --name training ./train.sh

# With OTEL streaming (requires daemon)
ig run --stream ./train.sh

# Check status from any terminal
ig run status
ig run logs training --tail 50
```

### What `ig run` Does

1. **Before execution:**
   - Generate unique run ID
   - Calculate content hash of script (if it's a file)
   - Register with daemon (if available)
   - Print structured header with run ID, hash, timestamp

2. **During execution:**
   - Execute command with PTY passthrough (preserve colors, interactivity)
   - Tee stdout/stderr to log files
   - Optionally stream to OTEL collector via daemon

3. **After execution:**
   - Print footer with exit code, duration
   - Mark run as complete in daemon
   - Keep logs accessible

### Script Hash Calculation

For script files:
- SHA256 of file contents
- First 8 chars displayed as "version"

For inline commands:
- SHA256 of the command string

### Integration Points

1. **Daemon registration:** Run appears in `idlergear daemon agents`
2. **OTEL logs:** If `--stream`, logs go to OTEL collector
3. **MCP visibility:** AI can query `idlergear_run_list()`, `idlergear_run_logs()`
4. **Run history:** Stored in `.idlergear/runs/`

### Example Session

Terminal 1 (AI assistant):
```
User: Run the training script and show me the results
AI: I see you need to run training. Please run this in your other terminal:
    ig run ./train.sh --stream
```

Terminal 2 (user):
```bash
$ ig run ./train.sh --stream
═══ IDLERGEAR RUN ═════════════════════════════════════════
ID:     run_abc123
Script: ./train.sh (hash: a1b2c3d4)
Time:   2026-01-11 04:30:00
Logs:   streaming to daemon
═══════════════════════════════════════════════════════════
[training output...]
═══ COMPLETE ═══════════════════════════════════════════════
Exit: 0 | Duration: 45.2s
═══════════════════════════════════════════════════════════
```

Terminal 1 (AI sees via MCP):
```
AI: I can see your training run completed. Let me check the logs...
    [calls idlergear_run_logs("run_abc123")]
```

Or if user copy-pastes:
```
User: [pastes output including header]
AI: I see this is run abc123 (script hash a1b2c3d4) which completed 
    successfully in 45.2s. Based on the output...
```

## Benefits Aligned with Vision

1. **Structured knowledge** - Runs are tracked with metadata, not just raw text
2. **Queryable history** - AI can access logs programmatically
3. **Cross-terminal context** - AI understands what ran where
4. **Version tracking** - Hash proves which script version ran
5. **Token efficiency** - AI can query specific log sections instead of parsing pasted text

## Implementation Scope

1. `ig` binary (or `ig-run` alias) - thin wrapper for user terminal
2. Enhanced `runs.py` - add hash calculation, header/footer output
3. OTEL integration - stream logs to collector
4. MCP tools already exist - just need to work with new run format

## Questions to Resolve

1. Should this be `ig run` (new binary) or `idlergear run-external`?
2. How to handle interactive commands that need TTY?
3. Should the header/footer be configurable (quiet mode)?
4. What happens if daemon isn't running? (Graceful degradation)
